# Datadog Reporter

## Download & Install

In order to configure the Datadog reporter, download the reporter plugin from [here](https://download.gravitee.io/#graviteeio-ee/apim/plugins/reporters/gravitee-reporter-datadog/). Once you’ve downloaded the zip file, you can add it to the gateway in the same way you do with [other plugins](../../getting-started/plugins/). Typically, you’ll install plugins in the /plugins directory of your installation. As with other reporters, the Datadog reporter plugin only needs to be installed on the gateway, not the management API.

{% hint style="info" %}
If you want to collect system metrics and logs from the management API service, use the [Datadog agent](https://docs.datadoghq.com/agent/?tab=Linux) to tail the management API logs, or collect from stdout.
{% endhint %}

If you are installing the Gravitee gateway via Helm, add the following entry in the `additionalPlugins`section (changing the version as needed):

```yaml
gateway:
  additionalPlugins:
    - https://download.gravitee.io/graviteeio-ee/apim/plugins/reporters/gravitee-reporter-datadog/gravitee-reporter-datadog-3.0.1.zip
```

## Configuration

To configure the Datadog reporter on the gateway, enable the reporters section in `gravitee.yml`. This will be something like:

```yaml
reporters:
  datadog:
    enabled: true
    site: "datadoghq.eu"
    authentication:
      #apiKeyPrefix: ""
      apiKey: "YOUR_API_KEY"
      #appKey: "YOUR_APP_KEY"
      #tokenScheme: ""
      #token: "YOUR_TOKEN"
      #username: "YOUR_USERNAME"
      #password: "YOUR_PASSWORD"
```

Authentication is required for the gateway to send reporting data to Datadog. Gravitee sends data to Datadog as an [API client](https://docs.datadoghq.com/api/latest/) over HTTP, and so needs to authenticate to Datadog. The basic way to do this is via an [API key](https://docs.datadoghq.com/account_management/api-app-keys/), but you can also configure application keys and client tokens, depending on what your Datadog account requires.

{% hint style="info" %}
You can obscure the value of this API key by using [configuration-level secrets](../../configure-apim/sensitive-data-management/configuration-level-secrets.md) in gravitee.yml.
{% endhint %}

## Data Type Mapping

Gravitee has different types of reporting data, and each type maps to a different resource type in Datadog. The mapping is as follows:

| Gravitee Convention                      | Examples                      | Datadog Convention |
| ---------------------------------------- | ----------------------------- | ------------------ |
| Metadata                                 | API name, user agent          | Tags               |
| Monitoring                               | CPU, memory usage             | Metrics            |
| EndpointStatus                           | Health check status           | Events             |
| [Metrics](./#metrics-sent-via-reporters) | Response time, content length | Metrics            |
| [Logs](./#log-data-sent-via-reporters)   | Request body, response body   | Log                |

The reporter sends metrics to Datadog with the prefix `gravitee.apim`. Metrics in Datadog appear with underscores between words, instead of the camelCase default shown in the metrics page. For example, `proxyResponseTimeMs` appears in Datadog as `proxy_response_time_ms`.

## Tags

[Tags](https://docs.datadoghq.com/getting_started/tagging/) are metadata attached to each metric sent to Datadog. They are raw strings that can be used to search and filter across metrics. Gravitee includes the following tags by default. You can also configure custom tags (see below). The tags correspond to the metrics generated by Gravitee reporters by default, but have a CamelCase naming convention.

| Tag Name       | Purpose                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| NodeId         | ID of the gateway                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| NodeHost       | Hostname of the gateway                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| Message        | A more detailed explanation of the error associated with the error key (if any)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Zone           | Text field set in gravitee.yml to indicate additional information about the gateway instance the API is running on                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ApplicationId  | The application ID; for a keyless plan, this value is "1"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| Api            | ID of the API                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ApiName        | Name of the API at the time of the request                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| EntrypointId   | ID of the entrypoint used in the API connection                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Endpoint       | The URL used by the proxy to forward the request to the upstream service                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ErrorKey       | If the policy chain was interrupted by an error, this key identifies the error type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Host           | The content of the `Host` header, passed when the incoming request was issued by the client                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| LocalAddress   | The address used as a destination when the incoming request was issued by the client                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| MappedPath     | If a path mapping has been defined to group requests in your analytics, this is the value of your mapping.                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Path           | The path used to perform the client request (starting from the context path of the API)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| Plan           | ID of the plan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| RemoteAddress  | The remote address used as a source when the incoming request was issued by the client                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| RequestId      | Unique identifier Universally Unique Identifier (UUID) identifying the request                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| SecurityToken  | The security token, if any type of security was used when processing the request                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Status         | HTTP response status code integer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| SubscriptionId | The subscription ID; for a keyless plan, this value will be the same as the value of the remote address field                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Tenant         | ID of the tenant evaluated for the API (see [tenants](../tenants.md))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| TransactionId  | Used to track end-to-end transactions spanning across multiple HTTP requests. The Gateway configuration allows defining an expected correlation ID header passed by a client request. If this header is set, the content of this field will be set to the value of the header. If no correlation header has been passed, the content of this field will be the same as the content of the request ID. This value will be propagated to the upstream service using the correlation header defined in the configuration (the default header is `X-Gravitee-Transaction-Id`). |
| Uri            | The URI used by the client to perform its request (this includes the context path of the request and query parameters)                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| User           | The authenticated user, if any type of security was used when processing the request                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| UserAgent      | The content of the `User-Agent` header, passed by the client when the incoming request was issued                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| HttpMethod     | HTTP verb used in the client connection                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |

## Custom Tags

You can add custom [tags](https://docs.datadoghq.com/getting_started/tagging/) to metrics sent to Datadog by adding the following section to the reporter configuration. Tags are a comma-separated list of strings; they can have a key-value format, or just be a raw string. No quotes are required.

```yaml
reporters:
  datadog:
    enabled: true
    # ... rest of the configuration
    # Set custom tag values
    # This is a list of strings
    customTags: >
      gateway: s1.company.com:9092,
      anotherCustomTagString
```

## Custom Metrics

You can use an assign metrics policy to add custom metrics to the output of the Datadog reporter. They appear in Datadog with the name gravitee.apim.{metricName}, where metricName is configured in the policy.

## Removing Fields from the Datadog Reporter

For cost or security reasons, you might not want to send all the above metrics to Datadog. In order to exclude certain metrics, you specify which metric you want to exclude, by data type. The configuration section is slightly different between v2 and v4 APIs.

```yaml
reporters:
  datadog:
    enabled: true
    # ... rest of the configuration
    # Set elements to exclude here
    v4-log:
      exclude:
        - entrypointRequest
        - entrypointResponse
    v4-message-log:
      exclude:
        - clientIdentifier
        - messageId
        - messagePayload
    v4-metrics:
      exclude:
        - httpMethod
    v4-message-metrics:
      exclude:
        - "*"
    log:
      exclude:
        - "*"
```
